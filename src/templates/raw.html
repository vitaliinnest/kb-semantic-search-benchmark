{% extends "base.html" %}
{% block title %}–§–∞–π–ª–∏ ‚Äî KB Search{% endblock %}

{% block head %}
<style>
  .page-heading { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
  .page-sub { font-size: 14px; color: var(--text-muted); margin-bottom: 24px; }

  /* ‚îÄ‚îÄ FLASH ‚îÄ‚îÄ */
  .flash-success { background: #e6f4ea; color: #1e6e3a; border: 1px solid #b6dfc5; }
  .flash-error   { background: #fce8e6; color: #c5221f; border: 1px solid #f5c6c4; }

  /* ‚îÄ‚îÄ UPLOAD ZONE ‚îÄ‚îÄ */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 28px 20px;
    text-align: center;
    cursor: pointer;
    transition: border-color .2s, background .2s;
    background: var(--surface);
    margin-bottom: 24px;
  }
  .upload-zone.dragover { border-color: var(--primary); background: #e8f0fe; }
  .upload-zone .uz-icon { font-size: 36px; margin-bottom: 8px; }
  .upload-zone .uz-title { font-size: 15px; font-weight: 600; color: var(--text); }
  .upload-zone .uz-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
  .upload-zone input[type=file] { display: none; }
  .upload-zone .uz-filelist {
    margin-top: 12px;
    font-size: 12.5px;
    color: var(--text-muted);
    text-align: left;
    max-height: 100px;
    overflow-y: auto;
    padding: 0 8px;
  }

  /* ‚îÄ‚îÄ FILE TABLE ‚îÄ‚îÄ */
  .files-card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 28px;
  }
  .files-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    background: #f8f9fa;
  }
  .files-card-header .title {
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
  }
  .files-card-header .count-badge {
    font-size: 12px;
    font-weight: 600;
    background: #e8f0fe;
    color: var(--primary);
    padding: 2px 10px;
    border-radius: 20px;
  }
  .files-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13.5px;
  }
  .files-table th {
    background: #f8f9fa;
    font-size: 11.5px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .5px;
    color: var(--text-muted);
    padding: 8px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }
  .files-table td {
    padding: 10px 16px;
    border-bottom: 1px solid #f0f0f0;
    vertical-align: middle;
  }
  .files-table tr:last-child td { border-bottom: none; }
  .files-table tr:hover td { background: #f8f9fa; }
  .file-icon { margin-right: 6px; }
  .file-name { font-weight: 500; color: var(--text); word-break: break-all; }
  .file-size { color: var(--text-muted); white-space: nowrap; }
  .file-date { color: var(--text-muted); white-space: nowrap; font-size: 12.5px; }
  .btn-delete {
    background: none;
    border: 1px solid #f5c6c4;
    color: #c5221f;
    border-radius: 20px;
    padding: 4px 14px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background .15s, border-color .15s;
  }
  .btn-delete:hover { background: #fce8e6; border-color: #c5221f; }

  /* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
  .empty-state {
    padding: 40px 20px;
    text-align: center;
    color: var(--text-muted);
  }
  .empty-state .es-icon { font-size: 40px; margin-bottom: 10px; }
  .empty-state p { font-size: 14px; }

  /* ‚îÄ‚îÄ CHUNK PANEL ‚îÄ‚îÄ */
  .chunk-panel {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 20px 24px;
  }
  .chunk-panel h2 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--text);
  }
  .params-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }
  .param-field label {
    display: block;
    font-size: 11.5px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .4px;
    color: var(--text-muted);
    margin-bottom: 6px;
  }
  .param-field input[type=number] {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 14px;
    background: var(--surface);
    color: var(--text);
    outline: none;
    transition: border-color .15s;
  }
  .param-field input[type=number]:focus { border-color: var(--primary); }
  .chunk-actions { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }

  /* ‚îÄ‚îÄ PROGRESS / RESULT ‚îÄ‚îÄ */
  #chunk-status {
    font-size: 13.5px;
    padding: 10px 16px;
    border-radius: 8px;
    display: none;
  }
  #chunk-status.running  { background: #fff3cd; color: #856404; border: 1px solid #ffe082; }
  #chunk-status.success  { background: #e6f4ea; color: #1e6e3a; border: 1px solid #b6dfc5; }
  #chunk-status.error    { background: #fce8e6; color: #c5221f; border: 1px solid #f5c6c4; }

  .spinner {
    display: inline-block;
    width: 14px; height: 14px;
    border: 2px solid #856404;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin .7s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .existing-chunks {
    font-size: 12.5px;
    color: var(--text-muted);
    margin-left: auto;
  }
  .existing-chunks strong { color: var(--text); }
</style>
{% endblock %}

{% block content %}
<div class="page-heading">üìÇ –§–∞–π–ª–∏ (raw)</div>
<div class="page-sub">–ó–∞–≤–∞–Ω—Ç–∞–∂—É–π—Ç–µ, –≤–∏–¥–∞–ª—è–π—Ç–µ –≤–∏—Ö—ñ–¥–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ —Ç–∞ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —á–∞–Ω–∫—ñ–Ω–≥</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, message in messages %}
  <div class="alert flash-{{ category }}" style="margin-bottom:18px;">{{ message }}</div>
  {% endfor %}
{% endwith %}

<!-- ‚îÄ‚îÄ UPLOAD ZONE ‚îÄ‚îÄ -->
<form id="upload-form" action="/raw/upload" method="POST" enctype="multipart/form-data">
  <div class="upload-zone" id="upload-zone">
    <div class="uz-icon">üì§</div>
    <div class="uz-title">–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–∞–π–ª–∏ —Å—é–¥–∏ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É</div>
    <div class="uz-sub">–ü—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è: .txt .md .rst .pdf .docx</div>
    <input type="file" id="file-input" name="files" multiple
           accept=".txt,.md,.rst,.pdf,.docx">
    <div class="uz-filelist" id="uz-filelist"></div>
  </div>
  <div style="text-align:center;margin-top:-12px;margin-bottom:24px;">
    <button type="submit" class="btn btn-primary" id="upload-btn" style="display:none;">
      ‚¨Ü –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
    </button>
  </div>
</form>

<!-- ‚îÄ‚îÄ FILES TABLE ‚îÄ‚îÄ -->
<div class="files-card">
  <div class="files-card-header">
    <span class="title">–§–∞–π–ª–∏ —É data/raw/</span>
    <span class="count-badge">{{ files|length }} —Ñ–∞–π–ª(—ñ–≤)</span>
  </div>
  {% if files %}
  <table class="files-table">
    <thead>
      <tr>
        <th>–ù–∞–∑–≤–∞</th>
        <th>–†–æ–∑–º—ñ—Ä</th>
        <th>–ó–º—ñ–Ω–µ–Ω–æ</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="files-tbody">
      {% for f in files %}
      {% set ext = f.name.rsplit('.', 1)[-1].lower() if '.' in f.name else '' %}
      <tr id="row-{{ loop.index }}">
        <td>
          <span class="file-icon">
            {% if ext == 'pdf' %}üìï
            {% elif ext in ('doc', 'docx') %}üìò
            {% elif ext in ('txt', 'md', 'rst') %}üìÑ
            {% else %}üìé{% endif %}
          </span>
          <span class="file-name">{{ f.name }}</span>
        </td>
        <td class="file-size">{{ (f.size / 1024)|round(1) }} KB</td>
        <td class="file-date">{{ f.mtime|int | datetimeformat }}</td>
        <td>
          <button class="btn-delete"
                  data-name="{{ f.name }}"
                  data-row="row-{{ loop.index }}"
                  onclick="deleteFile(this)">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state">
    <div class="es-icon">üóÇ</div>
    <p>–ü–∞–ø–∫–∞ <code>data/raw/</code> –ø–æ—Ä–æ–∂–Ω—è.<br>–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–∞–π–ª–∏ –≤–∏—â–µ.</p>
  </div>
  {% endif %}
</div>

<!-- ‚îÄ‚îÄ CHUNK PANEL ‚îÄ‚îÄ -->
<div class="chunk-panel">
  <h2>‚öôÔ∏è –†–æ–∑–±–∏—Ç—Ç—è –Ω–∞ —á–∞–Ω–∫–∏</h2>
  <div class="params-grid">
    <div class="param-field">
      <label>–ú—ñ–Ω. —Å–ª—ñ–≤</label>
      <input type="number" id="min-words" value="300" min="10" max="2000">
    </div>
    <div class="param-field">
      <label>–ú–∞–∫—Å. —Å–ª—ñ–≤</label>
      <input type="number" id="max-words" value="800" min="50" max="5000">
    </div>
    <div class="param-field">
      <label>–ü–µ—Ä–µ–∫—Ä–∏—Ç—Ç—è</label>
      <input type="number" id="overlap" value="80" min="0" max="500">
    </div>
  </div>

  <div class="chunk-actions">
    <button class="btn btn-primary" id="chunk-btn" onclick="runChunk()">
      ‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —á–∞–Ω–∫—ñ–Ω–≥
    </button>
    <div id="chunk-status"></div>
    {% if chunk_exists %}
    <span class="existing-chunks">
      –ü–æ—Ç–æ—á–Ω–∏–π chunks.jsonl: <strong>{{ chunk_count }}</strong> —á–∞–Ω–∫—ñ–≤
    </span>
    {% endif %}
  </div>
</div>

<script>
// ‚îÄ‚îÄ Upload zone DnD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const zone      = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');
const fileList  = document.getElementById('uz-filelist');
const uploadBtn = document.getElementById('upload-btn');

zone.addEventListener('click', () => fileInput.click());

zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
zone.addEventListener('drop', e => {
  e.preventDefault();
  zone.classList.remove('dragover');
  fileInput.files = e.dataTransfer.files;
  showFiles(fileInput.files);
});

fileInput.addEventListener('change', () => showFiles(fileInput.files));

function showFiles(files) {
  if (!files || files.length === 0) { fileList.innerHTML = ''; uploadBtn.style.display = 'none'; return; }
  const names = Array.from(files).map(f => `‚Ä¢ ${f.name}`).join('<br>');
  fileList.innerHTML = names;
  uploadBtn.style.display = 'inline-flex';
}

// ‚îÄ‚îÄ Delete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function deleteFile(btn) {
  const name = btn.dataset.name;
  if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–∞–π–ª ¬´${name}¬ª?`)) return;
  btn.disabled = true;
  btn.textContent = '‚Ä¶';

  const fd = new FormData();
  fd.append('name', name);

  fetch('/raw/delete', { method: 'POST', body: fd })
    .then(r => r.json())
    .then(data => {
      if (data.ok) {
        const row = document.getElementById(btn.dataset.row);
        if (row) row.remove();
        // –æ–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫
        const badge = document.querySelector('.count-badge');
        if (badge) {
          const cur = parseInt(badge.textContent) || 0;
          badge.textContent = `${Math.max(0, cur - 1)} —Ñ–∞–π–ª(—ñ–≤)`;
        }
        // If table is empty show empty state
        const tbody = document.getElementById('files-tbody');
        if (tbody && tbody.rows.length === 0) {
          const card = document.querySelector('.files-card');
          card.innerHTML = `<div class="files-card-header"><span class="title">–§–∞–π–ª–∏ —É data/raw/</span><span class="count-badge">0 —Ñ–∞–π–ª(—ñ–≤)</span></div>
            <div class="empty-state"><div class="es-icon">üóÇ</div><p>–ü–∞–ø–∫–∞ <code>data/raw/</code> –ø–æ—Ä–æ–∂–Ω—è.</p></div>`;
        }
      } else {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + data.error);
        btn.disabled = false;
        btn.textContent = 'üóë –í–∏–¥–∞–ª–∏—Ç–∏';
      }
    })
    .catch(() => {
      alert('–ú–µ—Ä–µ–∂–µ–≤–∞ –ø–æ–º–∏–ª–∫–∞');
      btn.disabled = false;
      btn.textContent = 'üóë –í–∏–¥–∞–ª–∏—Ç–∏';
    });
}

// ‚îÄ‚îÄ Chunk ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _pollTimer = null;

function runChunk() {
  const minW = document.getElementById('min-words').value;
  const maxW = document.getElementById('max-words').value;
  const ov   = document.getElementById('overlap').value;
  const btn  = document.getElementById('chunk-btn');
  const st   = document.getElementById('chunk-status');

  btn.disabled = true;
  setStatus('running', '<span class="spinner"></span> –ß–∞–Ω–∫—ñ–Ω–≥ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è‚Ä¶');

  const fd = new FormData();
  fd.append('min_words', minW);
  fd.append('max_words', maxW);
  fd.append('overlap',   ov);

  fetch('/raw/chunk', { method: 'POST', body: fd })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        setStatus('error', '‚ùå ' + data.error);
        btn.disabled = false;
        return;
      }
      _pollTimer = setInterval(pollStatus, 1500);
    })
    .catch(() => {
      setStatus('error', '‚ùå –ú–µ—Ä–µ–∂–µ–≤–∞ –ø–æ–º–∏–ª–∫–∞');
      btn.disabled = false;
    });
}

function pollStatus() {
  fetch('/raw/chunk/status')
    .then(r => r.json())
    .then(data => {
      if (data.running) return; // still running
      clearInterval(_pollTimer);
      _pollTimer = null;
      document.getElementById('chunk-btn').disabled = false;
      if (data.error) {
        setStatus('error', '‚ùå ' + data.error);
      } else {
        const count = data.result;
        setStatus('success', `‚úÖ –ì–æ—Ç–æ–≤–æ! –°—Ç–≤–æ—Ä–µ–Ω–æ <strong>${count}</strong> —á–∞–Ω–∫—ñ–≤. –§–∞–π–ª <code>data/chunks.jsonl</code> –æ–Ω–æ–≤–ª–µ–Ω–æ.`);
        // –æ–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫
        const ex = document.querySelector('.existing-chunks');
        if (ex) ex.innerHTML = `–ü–æ—Ç–æ—á–Ω–∏–π chunks.jsonl: <strong>${count}</strong> —á–∞–Ω–∫—ñ–≤`;
        else {
          const ca = document.querySelector('.chunk-actions');
          const sp = document.createElement('span');
          sp.className = 'existing-chunks';
          sp.innerHTML = `–ü–æ—Ç–æ—á–Ω–∏–π chunks.jsonl: <strong>${count}</strong> —á–∞–Ω–∫—ñ–≤`;
          ca.appendChild(sp);
        }
      }
    })
    .catch(() => {});
}

function setStatus(cls, html) {
  const el = document.getElementById('chunk-status');
  el.className = cls;
  el.innerHTML = html;
  el.style.display = 'block';
}
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}{% if query %}{{ query }} ‚Äî KB Search{% else %}KB Search{% endif %}{% endblock %}

{% block head %}
<style>
  /* ‚îÄ‚îÄ HERO (no-query state) ‚îÄ‚îÄ */
  .hero {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 80px;
    padding-bottom: 40px;
  }
  .hero-title {
    font-size: 48px;
    font-weight: 700;
    color: var(--primary);
    letter-spacing: -1.5px;
    margin-bottom: 6px;
  }
  .hero-sub {
    color: var(--text-muted);
    font-size: 15px;
    margin-bottom: 36px;
  }

  /* ‚îÄ‚îÄ SEARCH FORM ‚îÄ‚îÄ */
  .search-form {
    width: 100%;
  }
  .search-bar {
    display: flex;
    align-items: center;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 28px;
    padding: 6px 8px 6px 20px;
    box-shadow: var(--shadow);
    transition: box-shadow .18s, border-color .18s;
  }
  .search-bar:focus-within {
    border-color: var(--primary);
    box-shadow: 0 2px 12px rgba(26,115,232,.18);
  }
  .search-bar input[type="text"] {
    flex: 1;
    border: none;
    outline: none;
    font-size: 17px;
    background: transparent;
    color: var(--text);
    padding: 4px 0;
  }
  .search-bar button {
    flex-shrink: 0;
    padding: 9px 22px;
    border-radius: 22px;
  }

  .search-options {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin-top: 14px;
  }
  .search-options label {
    font-size: 15px;
    color: var(--text-muted);
    font-weight: 500;
    white-space: nowrap;
  }
  .search-options select,
  .search-options input[type="number"] {
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 7px 13px;
    font-size: 15px;
    background: var(--surface);
    color: var(--text);
    outline: none;
    transition: border-color .15s;
  }
  .search-options select:focus,
  .search-options input[type="number"]:focus {
    border-color: var(--primary);
  }
  .search-options input[type="number"] { width: 74px; }

  /* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
  .results-header {
    font-size: 15px;
    color: var(--text-muted);
    margin: 28px 0 16px;
  }
  .result-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .result-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px 22px;
    box-shadow: var(--shadow);
    transition: box-shadow .18s;
  }
  .result-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,.12); }

  .result-meta {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
    flex-wrap: wrap;
  }
  .rank {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-muted);
    min-width: 24px;
  }
  .source {
    font-size: 14px;
    color: var(--primary);
    font-weight: 500;
    word-break: break-all;
  }
  .chunk-id {
    font-size: 11px;
    color: var(--text-muted);
    font-family: monospace;
  }
  .result-snippet {
    font-size: 15px;
    line-height: 1.65;
    color: var(--text);
    margin-top: 8px;
    word-break: break-word;
  }
  .result-footer {
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 6px;
  }
  .result-length {
    font-size: 11px;
    color: var(--text-muted);
  }

  /* expand/collapse toggle */
  details summary {
    cursor: pointer;
    color: var(--primary);
    font-size: 13px;
    margin-top: 8px;
    user-select: none;
    list-style: none;
  }
  details summary::-webkit-details-marker { display: none; }
  details[open] summary::before { content: "‚ñ≤ "; }
  details:not([open]) summary::before { content: "‚ñº "; }
  .full-text {
    margin-top: 10px;
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    border-top: 1px solid var(--border);
    padding-top: 10px;
  }

  .no-results {
    text-align: center;
    padding: 60px 0;
    color: var(--text-muted);
    font-size: 15px;
  }

  /* ‚îÄ‚îÄ CONFIDENCE ‚îÄ‚îÄ */
  .confidence {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
  }
  .confidence-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    white-space: nowrap;
    min-width: 64px;
  }
  .confidence-bar-wrap {
    flex: 1;
    max-width: 220px;
    height: 6px;
    background: #e8eaed;
    border-radius: 3px;
    overflow: hidden;
  }
  .confidence-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width .4s ease;
  }
  .conf-high  .confidence-bar-fill { background: #1e8e3e; }
  .conf-mid   .confidence-bar-fill { background: #f9ab00; }
  .conf-low   .confidence-bar-fill { background: #d93025; }
  .confidence-pct {
    font-size: 12px;
    font-weight: 700;
    min-width: 38px;
    text-align: right;
  }
  .conf-high .confidence-pct { color: #1e8e3e; }
  .conf-mid  .confidence-pct { color: #b06000; }
  .conf-low  .confidence-pct { color: #d93025; }
  .confidence-tag {
    font-size: 11px;
    font-weight: 600;
    padding: 1px 8px;
    border-radius: 20px;
  }
  .conf-high .confidence-tag { background: #e6f4ea; color: #1e8e3e; }
  .conf-mid  .confidence-tag { background: #fef7e0; color: #b06000; }
  .conf-low  .confidence-tag { background: #fce8e6; color: #c5221f; }

  /* ‚îÄ‚îÄ BENCHMARK TABLE ‚îÄ‚îÄ */
  .benchmark-section {
    width: 100%;
    max-width: 820px;
    margin: 48px auto 0;
  }
  .benchmark-section h2 {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
    letter-spacing: -.3px;
  }
  .benchmark-meta {
    font-size: 15px;
    color: var(--text-muted);
    margin-bottom: 14px;
  }
  .benchmark-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 15px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
  }
  .benchmark-table thead th {
    background: #f1f3f4;
    color: var(--text-muted);
    font-weight: 600;
    text-align: left;
    padding: 12px 18px;
    border-bottom: 1.5px solid var(--border);
    white-space: nowrap;
  }
  .benchmark-table tbody tr:hover { background: #f8f9fa; }
  .benchmark-table tbody td {
    padding: 11px 18px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    vertical-align: middle;
  }
  .benchmark-table tbody tr:last-child td { border-bottom: none; }
  .benchmark-table td.num, .benchmark-table th.num { text-align: right; font-variant-numeric: tabular-nums; }
  .bm-best td { font-weight: 700; }
  .bm-badge {
    font-size: 10px;
    background: #e8f0fe;
    color: var(--primary);
    border-radius: 20px;
    padding: 1px 7px;
    margin-left: 6px;
    vertical-align: middle;
  }
</style>
{% endblock %}

{% block content %}
{% if not query %}
  <!-- HERO: no search yet -->
  <div class="hero">
    <div class="hero-title">KB Search</div>
    <div class="hero-sub">–°–µ–º–∞–Ω—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫ –ø–æ –±–∞–∑—ñ –∑–Ω–∞–Ω—å</div>
    <div class="search-form" style="max-width: 860px; width: 100%;">
      <form method="GET" action="/">
        <div class="search-bar">
          <input type="text" name="q" placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç‚Ä¶" autofocus autocomplete="off" />
          <button type="submit" class="btn btn-primary">–®—É–∫–∞—Ç–∏</button>
        </div>
        <div class="search-options">
          <label>–ú–æ–¥–µ–ª—å:
            <select name="model">
              {% for m in models %}
                <option value="{{ m.id }}" {% if m.id == selected_model %}selected{% endif %}>
                  {{ m.label }}{% if m.ndcg is defined %} ‚Äî nDCG¬†{{ "%.3f"|format(m.ndcg) }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </label>
          <label>–†–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤:
            <input type="number" name="top_k" min="1" max="20" value="{{ top_k }}" />
          </label>
        </div>
      </form>
    </div>
  </div>

  {% if benchmark and benchmark.models %}
  {% set bm_models = benchmark.models %}
  {% set best_ndcg = bm_models | map(attribute='ndcg_at_k') | max %}
  <div class="benchmark-section">
    <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –±–µ–Ω—á–º–∞—Ä–∫—É</h2>
    <div class="benchmark-meta">
      –ß–∞—Å: {{ benchmark.timestamp[:16] | replace('T', '¬†') }}
      &nbsp;¬∑¬† –ó–∞–ø–∏—Ç—ñ–≤: {{ benchmark.queries_count }}
      &nbsp;¬∑¬† top‚Äëk&nbsp;=&nbsp;{{ benchmark.top_k }}
    </div>
    <table class="benchmark-table">
      <thead>
        <tr>
          <th>–ú–æ–¥–µ–ª—å</th>
          <th class="num">Recall@{{ benchmark.top_k }}</th>
          <th class="num">MRR@{{ benchmark.top_k }}</th>
          <th class="num">nDCG@{{ benchmark.top_k }}</th>
          <th class="num">–ó–∞–ø–∏—Ç—ñ–≤</th>
        </tr>
      </thead>
      <tbody>
        {% for m in bm_models | sort(attribute='ndcg_at_k', reverse=True) %}
        {% set is_best = (m.ndcg_at_k == best_ndcg) %}
        <tr {% if is_best %}class="bm-best"{% endif %}>
          <td>
            {{ m.model_name }}
            {% if is_best %}<span class="bm-badge">‚òÖ best</span>{% endif %}
          </td>
          <td class="num">{{ "%.3f" | format(m.recall_at_k) }}</td>
          <td class="num">{{ "%.3f" | format(m.mrr_at_k) }}</td>
          <td class="num">{{ "%.3f" | format(m.ndcg_at_k) }}</td>
          <td class="num">{{ m.queries_evaluated }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

{% else %}
  <!-- COMPACT HEADER with search bar -->
  <div style="margin-bottom: 24px;">
    <form method="GET" action="/" class="search-form">
      <div class="search-bar">
        <input type="text" name="q" value="{{ query }}" autofocus autocomplete="off" />
        <button type="submit" class="btn btn-primary">–®—É–∫–∞—Ç–∏</button>
      </div>
      <div class="search-options">
        <label>–ú–æ–¥–µ–ª—å:
          <select name="model">
            {% for m in models %}
              <option value="{{ m.id }}" {% if m.id == selected_model %}selected{% endif %}>
                {{ m.label }}{% if m.ndcg is defined %} ‚Äî nDCG¬†{{ "%.3f"|format(m.ndcg) }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </label>
        <label>–†–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤:
          <input type="number" name="top_k" min="1" max="20" value="{{ top_k }}" />
        </label>
      </div>
    </form>
  </div>

  {% if error %}
    <div class="alert alert-error">‚ö† –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –ø–æ—à—É–∫—É: {{ error }}</div>
  {% elif results %}
    <div class="results-header">–ó–Ω–∞–π–¥–µ–Ω–æ {{ results|length }} —Ä–µ–∑—É–ª—å—Ç–∞—Ç{% if results|length == 1 %}{% elif results|length < 5 %}–∏{% else %}—ñ–≤{% endif %} –¥–ª—è <strong>¬´{{ query }}¬ª</strong></div>
    <div class="result-list">
      {% for r in results %}
      {% set pct = (r.score * 100) | round(1) %}
      {% set pct_clamped = [[pct, 0]|max, 100]|min %}
      {% if pct_clamped >= 60 %}
        {% set conf_class = "conf-high" %}
        {% set conf_label = "–í–∏—Å–æ–∫–∞" %}
      {% elif pct_clamped >= 35 %}
        {% set conf_class = "conf-mid" %}
        {% set conf_label = "–°–µ—Ä–µ–¥–Ω—è" %}
      {% else %}
        {% set conf_class = "conf-low" %}
        {% set conf_label = "–ù–∏–∑—å–∫–∞" %}
      {% endif %}
      <div class="result-card">
        <div class="result-meta">
          <span class="rank">#{{ r.rank }}</span>
          <span class="source">üìÑ {{ r.source }}</span>
          <span class="chunk-id">{{ r.chunk_id }}</span>
        </div>
        <div class="confidence {{ conf_class }}">
          <span class="confidence-label">–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—Å—Ç—å</span>
          <div class="confidence-bar-wrap">
            <div class="confidence-bar-fill" style="width: {{ pct_clamped }}%"></div>
          </div>
          <span class="confidence-pct">{{ "%.1f"|format(pct_clamped) }}%</span>
          <span class="confidence-tag">{{ conf_label }}</span>
          <span style="font-size:11px; color:var(--text-muted); margin-left:4px;">score {{ "%.4f"|format(r.score) }}</span>
        </div>
        <div class="result-snippet">{{ r.snippet }}</div>
        {% if r.full_length > 400 %}
        <details>
          <summary>–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç ({{ r.full_length }} —Å–∏–º–≤–æ–ª—ñ–≤)</summary>
          <div class="full-text">{{ r.full_text }}</div>
        </details>
        {% endif %}
        <div class="result-footer">
          <span class="result-length">{{ r.full_length }} —Å–∏–º–≤–æ–ª—ñ–≤</span>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="no-results">
      üòï –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –∑–∞–ø–∏—Ç–æ–º <strong>¬´{{ query }}¬ª</strong>
    </div>
  {% endif %}
{% endif %}
{% endblock %}

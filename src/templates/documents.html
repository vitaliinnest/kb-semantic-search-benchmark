{% extends "base.html" %}
{% block title %}–î–æ–∫—É–º–µ–Ω—Ç–∏ ‚Äî KB Search{% endblock %}

{% block head %}
<style>
  .page-heading {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  .page-sub {
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 24px;
  }

  /* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .filter-bar label {
    font-size: 13px;
    color: var(--text-muted);
    font-weight: 500;
    white-space: nowrap;
  }
  .filter-bar select {
    border: 1.5px solid var(--border);
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 13px;
    background: var(--surface);
    color: var(--text);
    outline: none;
    transition: border-color .15s;
  }
  .filter-bar select:focus { border-color: var(--primary); }
  .filter-bar button {
    padding: 7px 18px;
    border-radius: 20px;
    font-size: 13px;
  }

  .docs-summary-bar {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 18px;
  }
  .docs-summary-bar strong { color: var(--text); }

  /* ‚îÄ‚îÄ ACCORDION GROUP ‚îÄ‚îÄ */
  .source-accordion {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .source-group {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    transition: box-shadow .18s;
  }
  .source-group[open] {
    box-shadow: 0 4px 18px rgba(0,0,0,.1);
  }

  .source-group > summary {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 18px;
    cursor: pointer;
    list-style: none;
    user-select: none;
    background: var(--surface);
    border-bottom: 1.5px solid transparent;
    transition: background .15s, border-color .15s;
  }
  .source-group > summary::-webkit-details-marker { display: none; }
  .source-group[open] > summary {
    border-bottom-color: var(--border);
    background: #f8f9fa;
  }
  .source-group > summary:hover { background: #f1f3f4; }

  .summary-arrow {
    font-size: 11px;
    color: var(--text-muted);
    transition: transform .2s;
    flex-shrink: 0;
  }
  .source-group[open] > summary .summary-arrow {
    transform: rotate(90deg);
  }

  .summary-icon { font-size: 16px; flex-shrink: 0; }

  .summary-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .summary-badge {
    flex-shrink: 0;
    font-size: 11.5px;
    font-weight: 600;
    background: #e8f0fe;
    color: var(--primary);
    border-radius: 20px;
    padding: 2px 10px;
  }

  /* ‚îÄ‚îÄ CHUNKS INSIDE ACCORDION ‚îÄ‚îÄ */
  .chunks-body {
    padding: 12px 16px 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .chunk-card {
    background: #fafafa;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    transition: box-shadow .15s;
  }
  .chunk-card:hover { box-shadow: 0 2px 10px rgba(0,0,0,.08); }

  .chunk-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
    flex-wrap: wrap;
  }
  .chunk-id-badge {
    font-size: 11px;
    font-family: monospace;
    background: #f1f3f4;
    color: var(--text-muted);
    padding: 2px 8px;
    border-radius: 20px;
  }
  .chunk-len-badge {
    font-size: 11px;
    background: #f0fdf4;
    color: #166534;
    padding: 2px 8px;
    border-radius: 20px;
    font-weight: 500;
  }
  .chunk-text {
    font-size: 13.5px;
    line-height: 1.65;
    color: var(--text);
    word-break: break-word;
  }

  .chunk-expand {
    margin-top: 6px;
  }
  .chunk-expand summary {
    cursor: pointer;
    color: var(--primary);
    font-size: 12.5px;
    user-select: none;
    list-style: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .chunk-expand summary::-webkit-details-marker { display: none; }
  .chunk-expand[open] summary .exp-icon::before { content: "‚ñ≤"; }
  .chunk-expand:not([open]) summary .exp-icon::before { content: "‚ñº"; }
  .full-text {
    margin-top: 6px;
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    border-top: 1px solid var(--border);
    padding-top: 8px;
  }

  /* ‚îÄ‚îÄ EXPAND / COLLAPSE ALL ‚îÄ‚îÄ */
  .bulk-actions {
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
  }
  .bulk-actions button {
    font-size: 12px;
    padding: 5px 14px;
    border-radius: 20px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    color: var(--text);
    cursor: pointer;
    transition: background .15s, border-color .15s;
  }
  .bulk-actions button:hover { background: #f1f3f4; border-color: var(--primary); }
</style>
{% endblock %}

{% block content %}
<div class="page-heading">üìö –î–æ–∫—É–º–µ–Ω—Ç–∏</div>
<div class="page-sub">–£—Å—ñ —á–∞–Ω–∫–∏ –±–∞–∑–∏ –∑–Ω–∞–Ω—å, –∑–≥—Ä—É–ø–æ–≤–∞–Ω—ñ –∑–∞ –¥–∂–µ—Ä–µ–ª–æ–º</div>

<!-- FILTER FORM -->
<form method="GET" action="/documents" class="filter-bar">
  <label>–î–∂–µ—Ä–µ–ª–æ:
    <select name="source" onchange="this.form.submit()">
      <option value="">‚Äî –≤—Å—ñ ‚Äî</option>
      {% for s in all_sources %}
        <option value="{{ s }}" {% if s == source_filter %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </label>
  {% if source_filter %}
    <a href="/documents" class="btn" style="background:#f1f3f4; color:var(--text);">‚úï –°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</a>
  {% endif %}
</form>

<div class="docs-summary-bar">
  <strong>{{ total_sources }}</strong> {% if total_sources == 1 %}–¥–æ–∫—É–º–µ–Ω—Ç{% elif total_sources < 5 %}–¥–æ–∫—É–º–µ–Ω—Ç–∏{% else %}–¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤{% endif %},&nbsp;
  <strong>{{ total_chunks }}</strong> {% if total_chunks == 1 %}—á–∞–Ω–∫{% elif total_chunks < 5 %}—á–∞–Ω–∫–∏{% else %}—á–∞–Ω–∫—ñ–≤{% endif %}
  {% if source_filter %} ‚Äî —Ñ—ñ–ª—å—Ç—Ä: <strong>{{ source_filter }}</strong>{% endif %}
</div>

{% if source_groups %}

{% if source_groups|length > 1 %}
<div class="bulk-actions">
  <button type="button" onclick="expandAll()">‚ñº –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –≤—Å—ñ</button>
  <button type="button" onclick="collapseAll()">‚ñ≤ –ó–≥–æ—Ä–Ω—É—Ç–∏ –≤—Å—ñ</button>
</div>
{% endif %}

<!-- ACCORDION -->
<div class="source-accordion" id="accordion">
  {% for group in source_groups %}
  <details class="source-group" {% if source_filter or source_groups|length == 1 %}open{% endif %}>
    <summary>
      <span class="summary-arrow">‚ñ∂</span>
      <span class="summary-icon">üìÑ</span>
      <span class="summary-name" title="{{ group.source }}">{{ group.source }}</span>
      <span class="summary-badge">{{ group.count }} —á–∞–Ω–∫—ñ–≤</span>
    </summary>

    <div class="chunks-body">
      {% for c in group.chunks %}
      <div class="chunk-card">
        <div class="chunk-meta">
          <span class="chunk-id-badge">{{ c.chunk_id }}</span>
          <span class="chunk-len-badge">{{ c.text|length }} —Å–∏–º–≤.</span>
        </div>
        <div class="chunk-text">{{ c.text[:350] }}{% if c.text|length > 350 %}‚Ä¶{% endif %}</div>
        {% if c.text|length > 350 %}
        <details class="chunk-expand">
          <summary><span class="exp-icon"></span>&nbsp;–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç</summary>
          <div class="full-text">{{ c.text }}</div>
        </details>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </details>
  {% endfor %}
</div>

{% else %}
<div class="alert alert-info">–ß–∞–Ω–∫–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω—ñ.</div>
{% endif %}

<script>
function expandAll() {
  document.querySelectorAll('#accordion details.source-group').forEach(d => d.open = true);
}
function collapseAll() {
  document.querySelectorAll('#accordion details.source-group').forEach(d => d.open = false);
}
</script>
{% endblock %}

